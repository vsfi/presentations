## Маршрутизация между VLAN, DLink
![](http://www.dlink.com/-/media/Images/Products/DES/1026G/DES1026GC1ImageFrontL.png)

---

## VLAN (802.1Q)
###### Просто дополнительное поле в ethernet заголовке 
![](https://www.dialogic.com/webhelp/BorderNet2020/2.0.0/WebHelp/DG_WG_VLAN_TAG_Format.png "Очень схематичное изображение тегированного ethernet фрейма")

* Под сам тег отведено 12бит, значит, возможно всего 4096 вланов
* VLAN заголовок вставляется во фрейм после src/dst MAC адресов, а значит, тегированные фреймы могут пролезать через "тупые" свитчи.

___
##VLAN
##### И порты коммутаторов
* Порты могут работать в трех режимах : **tagged** **untagged** **смешанный**
* **untagged** это порт доступа в терминологии Cisco
* **tagged** это транковый порт в терминологии Cisco
* **Смешанный** режим предполагает один нетегированный влан и несколько тегированных

___
##VLAN
##### И порты коммутаторов (untagged)
* Нетегированный порт на все входящие фреймы навешивает тег указанный в конфигурации, входящие фреймы с тегом указанным в конфигурации избавляются от тега и выкидываются с порта как обычные. С несовпадающим тегом - отбрасываются.

___

##VLAN
##### И порты коммутаторов (tagged и смешанный режим)
* Порты настроенные в режиме tagged прозрачно пропускают через себя фреймы со всеми разрешенными в конфигурации тегам и отбрасывают теги которых нет среди разрешенных. 
* Тегированный порт одновременно может работать как порт доступа для одного выбранного vlan. В общепринятой (цисковской) терминологии это называется native vlan.

---
##VLAN
##### И сетевой уровень модели OSI (ip)
* Никак не связаны. Однако, применяют обычно принцип *"один vlan - одна ip сеть"*
* На одном тегированном физическом интерфейсе может быть множество vlan, а значит - и ip сетей. В связи с этим в сетях применяется технология ~~говна и палок~~ _"роутера на палочке"_

___
##VLAN
##### Роутер на палочке
![](http://2.bp.blogspot.com/-MqiR1De2Wfk/Ui1ue0VIAVI/AAAAAAAAAQ8/f7bfdyfi9fo/s1600/Inter-vlan2.gif)
 
На одном физическом интерфейсе роутера несколько тегированных сабинтерфейсов 
___
## VLAN
##### Роутер на палочке. пояснения. 
* На интерфейсе коммутатора настроен транк (тегированный порт пропускающий несколько вланов
* На интерфейсе роутера создано аналогичное количеству вланов количество сабинтерфейсов. Представить это можно аналогично тому как если бы у роутера было по отдельному порту на влан)

___

## VLAN
##### Роутер на палочке. Как идут пакеты.

* На каждом тегированном сабинтерфейсе роутера назначен адрес соответствующей сети. Этот адрес будет шлюзом для устройств во влане.
* Пакет идущий из одного влана в другой идет с коммутатора на роутер, попадая на тегированный сабинтерфейс, роутер принимает решение о маршрутизации, перевешивает на фрейме влан тег и выкидывает пакет в другой влан через тегированный сабинтерфейс. При этом физический интерфейс используется один и тот же. Отсюда и название - роутер на палочке.

---
##VLAN и безопасность
* Вланы ни в коем случае не являются технологией надежной изоляции трафика внутри бродкаст сегмента
* Нет шифрования, нет защиты от прослушки и контроля подмены данных в пути (man in the middle)

___
##VLAN и безопасность
##### хорошие практики
* Не разрешать на транковых портах ненужные вланы
* Не использовать смешанный режим на клиентских портах за исключением случая подключения к ip телефону
* Никогда не подключать транковые порты к "тупым коммутаторам"
---
## Роутер на палочке на примере RouterOS
##### Приготовления перед практикой

* Нужно на всякий случай сгенерировать новый MAC адрес на виртуальной сетевой карточке виртуальнйо машины-роутера.

* Нужно разрешить неразборчивый режим на сетевой карточке виртуальной машины, иначе вланы пропускаться не будут.

* В качестве роутера выбирать нужно ноутбук с ethernet разъемом, сетевая карточка виртуальной машины должна быть сбриджена с ним.

___
## Роутер на палочке на примере RouterOS
##### Приготовления перед практикой

* Конфигурацию роутера нужно сбросить в ноль. Сделать это можно командой:
```bash
system reset-configuration
```

---
##Коммутаторы Dlink
###### ~~выдумка сатаны~~
* Можно настраивать через веб интерфейс, telnet и ssh.
* Адрес по-умолчанию 10.90.90.90/8
* Нет разделения на командный режим и режим show команд как в Cisco
* Стандартный логин **admin** без пароля

---
##ROUTEROS и вланы
* Добавление тегированного VLAN интерфейса:
```bash
[johnny@johnny-slowpoke] > interface vlan add vlan-id=10 
interface=ether1 name=nport
```

* Добавление адреса и дальнейшая работа с VLAN сабинтерфейсом возможны как с обычным ethernet:
```bash
[johnny@johnny-slowpoke] > ip address add interface=nport 
address=10.4.4.4/25
```
* Нужно помнить что выключение физического родительского интерфейса уложит и все сабинтерфейсы.

---
##Последовательность действий
* Включаем коммутатор
* Один ноутбук для настройки коммутатора, один - роутер, 2+ - клиенты в разных вланах. **НЕ** подключаем тестовые коммутаторы к остальной сети
* Запускаем RouterOS, создаем сабинтерфейсы и адреса на них

___
##Последовательность действий
* Лезем на коммутатор через консоль или веб интерфейс, настраиваем порты подназначенные для клиентов в untagged и порт смотрящий на "роутер" в транковый режим
* Подключаем клиентов, назначаем адреса и проверяем. пингуем друг друга. Пинги не ходят.
* Втыкаем роутер, все должно заработать
